# ğŸ’ ìŠ¤í”„ë§ ë¶€íŠ¸ ê¸°ì´ˆ(êµìœ¡ 5íšŒì°¨_230421) {#top}
> created : 2023-04-21
> 
> updated : 2023-04-21
> 
> author : ë°±ë¯¼ì£¼
##
***
## ğŸ”¶ ëª©ì°¨
1. [ê°•ì˜ Background](#-ê°•ì˜-background)
2. [Mavenì—ì„œì˜ JPA ì‚¬ìš©](#-mavenì—ì„œì˜-jpa-ì‚¬ìš©)
    - [ì¡°íšŒ](#-ì¡°íšŒ) / [ìˆ˜ì •](#-ìˆ˜ì •) / [ì‚­ì œ](#-ì‚­ì œ)
3. [Springbootì—ì„œì˜ JPA ì‚¬ìš©](#-spring-bootì—ì„œì˜-jpa-ì‚¬ìš©)
    - [Annotation í™œìš©í•˜ì—¬ Entity ë§Œë“¤ê¸°](#-annotation-í™œìš©í•˜ì—¬-entity-ë§Œë“¤ê¸°)
    - [í™˜ê²½ì„¤ì •](#-í™˜ê²½-ì„¤ì •)
    - [Spring data JPA ì“°ëŠ” ë°©ë²•](#-spring-data-jpa-ì“°ëŠ”-ë°©ë²•)
    - [JPA í…ŒìŠ¤íŠ¸í•˜ê¸°](#-jpa-í…ŒìŠ¤íŠ¸í•´ë³´ê¸°)
    - [Transaction service êµ¬í˜„í•˜ê¸°](#-transaction-service-êµ¬í˜„í•˜ê¸°ë¹„ì¦ˆë‹ˆìŠ¤ì—ì„œ-ì‚¬ìš©)
4. [MVC íŒ¨í„´](#-mvc-íŒ¨í„´)
    - [Rest APIë¡œ MVC êµ¬í˜„í•˜ê¸°](#-rest-apië¡œ-mvc-êµ¬í˜„í•˜ê¸°)
    - [application.ymlì„ í†µí•´ MVC êµ¬ì¡° ìë™ì ìœ¼ë¡œ ë§Œë“¤ê¸°](#-applicationymlì„-í†µí•´-mvc-êµ¬ì¡°-ìë™ì ìœ¼ë¡œ-ë§Œë“¤ê¸°)
6. [Spring ê¸°ì´ˆ](#-spring-ê¸°ì´ˆ)
***
## ğŸ”¶ ê°•ì˜ Background
- [ìˆ˜ì—…ë©”ëª¨](https://gist.github.com/carami/d3bb434cacf371d44e71538b93e6c212)
- [ìˆ˜ì—…ì‹œê°„ GITHUB - todo project](https://github.com/carami/koscom_2023)
***
## ğŸ”¶ Mavenì—ì„œì˜ JPA ì‚¬ìš©
#### ğŸ”¹ ì¡°íšŒ
```java
// ì¡°íšŒ
   Product findProduct = em.find(Product.class, 1L);
   Product findProduct2 = em.find(Product.class, 1L);
   if (findProduct == findProduct2) System.out.println("ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ì…ë‹ˆë‹¤."); //ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ì„
```
#### ğŸ”¹ ìˆ˜ì •
```java
// ìˆ˜ì •(ì¡°íšŒ í›„ ìˆ˜ì •)
   Product findProduct = em.find(Product.class, 1L);
   findProduct.setName("pen");
   findProduct.setPrice(5000);
```
#### ğŸ”¹ ì‚­ì œ
```java
// ì‚­ì œ(ì¡°íšŒ í›„ ì‚­ì œ)
   Product findProduct = em.find(Product.class, 1L);
   em.remove(findProduct);

   System.out.println("persist() ìˆ˜í–‰í›„!!");
   tx.commit(); //commitê¹Œì§€ í•´ì•¼ DBì— ë°˜ì˜ ì™„ë£Œ
   System.out.println("commit  ìˆ˜í–‰ í›„!!");
```
***
## ğŸ”¶ Spring bootì—ì„œì˜ JPA ì‚¬ìš©
- í”„ë¡œì íŠ¸ ì„¤ì • ì‹œ ì¶”ê°€íŒŒì¼
  - Spring Boot DevTools, Lombok, Spring Web, Spring Data JPA, Thymeleaf, H2 Database
    - Spring Data JPA : Springì—ì„œ JPAë¥¼ ë” ì‰½ê²Œ ì“°ê²Œ í•´ì¤Œ
#### ğŸ”¹ Annotation í™œìš©í•˜ì—¬ Entity ë§Œë“¤ê¸°
```java
package com.example.todo.domain;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Table;

import lombok.Getter;
import lombok.Setter;
import lombok.ToString;

@Entity
@Table(name = "todos")
@Getter
@Setter
@ToString
public class Todo {

    @Id
    @GeneratedValue
    private Long id;
    @Column(name="todo_sample", unique=true, length=50)
    private String todo;
    private boolean done;
}
```
#### ğŸ”¹ í™˜ê²½ ì„¤ì •
- **`application.properties`ëŠ” ì˜¤íƒ€ ì²´í¬ë¥¼ ëª»í•´ì„œ `application.yml`ìœ¼ë¡œ íŒŒì¼ëª… Rename í•„ìš”**
  - application.properties : springbootì—ì„œ ìµœì†Œí•œì˜ ì„¤ì •ì— ëŒ€í•œ ê°’ì„ ì•Œë ¤ì£¼ë©´ ì‹¤í–‰ì„ ì•Œì•„ì„œ í•´ì£¼ëŠ” íŒŒì¼
- Datasource : JDBC ì„¤ì •
- JPA : DB ì„¤ì •(ìˆ˜ì—…ì—ì„œëŠ” hibernateë¡œ ì„¤ì •)
- portë¥¼ 80ìœ¼ë¡œ ì„¤ì •í•´ë†“ìœ¼ë©´ urlì— portë²ˆí˜¸ ì“¸ í•„ìš” ì—†ìŒ
  ```yml
  server:
    port: 80
  ```
#### ğŸ”¹ Spring Data JPA ì“°ëŠ” ë°©ë²•
```java
package com.example.todo.repository;

import org.springframework.data.jpa.repository.JpaRepository;

import com.example.todo.domain.Product;

public interface ProductRepository extends JpaRepository<Product, Long> { 
    //JpaRepositoryë¼ëŠ” interfaceì—ê²Œ 1) ì–´ë–¤ Entityë¥¼ ì‚¬ìš©í•  ê±´ì§€
    //2) ê·¸ Entityì˜ keyì˜ typeì´ ë­”ì§€ë§Œ ì•Œë ¤ì£¼ë©´ ë‚˜ë¨¸ì§€ëŠ” ì•Œì•„ì„œ ë‹¤ êµ¬í˜„í•´ì¤Œ
}
```
#### ğŸ”¹ JPA í…ŒìŠ¤íŠ¸í•´ë³´ê¸°
- **src/test/javaì—ì„œ í•´ì•¼í•¨**
- ë©”ì†Œë“œ ë‹¨ìœ„ë¡œ í•´ì•¼í•˜ë‹ˆê¹Œ ì£¼ì„ì²˜ë¦¬ ì—†ì´ ê°„í¸í•˜ê²Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
  ```java
  package com.example.todo.repository;

  import java.util.Optional;

  import org.junit.jupiter.api.Test;
  import org.springframework.beans.factory.annotation.Autowired;
  import org.springframework.boot.test.context.SpringBootTest;

  import com.example.todo.domain.Product;

  @SpringBootTest
  public class ProductRepositoryTest {

    @Autowired
    ProductRepository productRepository;

    @Test // Tableì— Add Test
    void addProduct() throws Exception {
        Product p = new Product();
        p.setName("ì»¤í”¼");
        p.setPrice(5000);
        
        p = productRepository.save(p); // Repositoryì— saveë¥¼ í•´ì¤Œ
        assertNotNull(p.getId()); // junitì˜ ì¥ì 
    }

    @Test // Addí•œ Entity ê°–ê³ ì˜¤ê¸°
    @DisplayName("Idì— í•´ë‹¹í•˜ëŠ” ìƒí’ˆì¡°íšŒ")
    void getProduct() {
        Optional<Product> pOptional = productRepository.findById(34L);
        System.out.println(pOptional);
        assertNotNull(pOptional.get());
    }
  }
  ```
#### ğŸ”¹ Transaction Service êµ¬í˜„í•˜ê¸°(ë¹„ì¦ˆë‹ˆìŠ¤ì—ì„œ ì‚¬ìš©)
```java
package com.example.todo.service;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.todo.domain.Todo;
import com.example.todo.repository.TodoRepository;

@Service
public class TodoService {
    @Autowired
    private TodoRepository todoRepository;

    @Transactional(readOnly = true)
    public List<Todo> getTodos(){
        return todoRepository.findAll(Sort.by("id").descending());
    }

    @Transactional
    public Todo addTodo(String todo){
        Todo insertTodo = new Todo();
        insertTodo.setTodo(todo);

        return todoRepository.save(insertTodo);
    }

    @Transactional(readOnly = true)
    public Todo getTodo(Long id){
        return todoRepository.findById(id).get();
    }

    @Transactional
    public Todo updateTodo(Long id) {
        System.out.println("service updateTodo start!!");
        Todo findTodo = null;
        try {
            findTodo = todoRepository.findById(id).orElseThrow();
            findTodo.setDone(!findTodo.isDone());
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            System.out.println("service update end!!");
        }

        return findTodo;
    }

    public void deleteTodo(Long id) {
        Optional<Todo> resultOptional = todoRepository.findById(id);
        if (resultOptional.isEmpty())
            return;
        todoRepository.delete(resultOptional.get());
    }

}
```
***
## ğŸ”¶ MVC íŒ¨í„´
- Rest APIë¥¼ ì‚¬ìš©í•´ì„œ êµ¬í˜„
  - Rest API = Web APIë€? ìì›ì„ urlì„ í†µí•´ì„œ ë‚˜íƒ€ë‚´ëŠ” ê¸°ìˆ 
  - **Thunder Client(Extensionì—ì„œ ì„¤ì¹˜ ê°€ëŠ¥)** : Rest API ë°ì´í„°ë¥¼ VSCODEìƒì—ì„œ ë³´ì—¬ì¤Œ
#### ğŸ”¹ Rest APIë¡œ MVC êµ¬í˜„í•˜ê¸°
```java
package com.example.todo.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PatchMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.example.todo.domain.Todo;
import com.example.todo.service.TodoService;

@RestController
@RequestMapping("/api/todos")
public class TodoApiController {

    @Autowired
    private TodoService todoService;

    @GetMapping
    public List<Todo> getTodos() {
        return todoService.getTodos();
    }

    @GetMapping("/{id}")
    public Todo getTodo(@PathVariable("id") Long id) { // springì´ ì•Œì•„ì„œ idë¥¼ ë„£ì–´ì¤Œ
        return todoService.getTodo(id);
    }

    @PostMapping
    public Todo addTodo(@RequestBody Todo todo) {
        return todoService.addTodo(todo.getTodo());
    }

    @PatchMapping
    public Todo updateTodo(@RequestBody Todo todo) {
        return todoService.updateTodo(todo.getId());
    }

    @DeleteMapping("/{id}")
    public String deleteTodo(@PathVariable Long id) {
        todoService.deleteTodo(id);
        return "##########delete complete!";
    }

}
```
#### ğŸ”¹ application.ymlì„ í†µí•´ mvc êµ¬ì¡° ìë™ì ìœ¼ë¡œ ë§Œë“¤ê¸°
```yml
spring:
  mvc:
    static-path-pattern:
    static-locations: classpath:/
```
***
## ğŸ”¶ Spring ê¸°ì´ˆ
- ë¡œê·¸ ì°ê¸°
  ```java
  private static Logger logger = LoggerFactory.getLogger(TodoRepository.class);
		
  @BeforeEach
  public void init(){
		logger.info("==================ì‹œì‘ì „");
  }
  ```
***
[ë§¨ ìœ„ë¡œ ê°€ê¸°](#top)
